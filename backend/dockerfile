
FROM node:18-bullseye as build

WORKDIR /app


RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    && rm -rf /var/lib/apt/lists/*


RUN npm install -g @nestjs/cli typescript


COPY .env /app/.env
COPY package.json .
COPY yarn.lock .


RUN yarn install


COPY . .


RUN yarn tsc


FROM node:18-bullseye

WORKDIR /app

ENV NODE_ENV=production


RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g @nestjs/cli typescript


COPY .env /app/.env
COPY package.json .
COPY yarn.lock .
RUN yarn install --build-from-source


COPY --from=build /app/dist /app/dist
COPY ormconfig.js .


EXPOSE 5000
ENTRYPOINT ["node", "dist/main"]
